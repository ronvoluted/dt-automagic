<?xml version='1.0' encoding='UTF-8' standalone='yes' ?>
<data version="1.37.0">
  <trigger type="global_variable_date">
    <useDefaultName>true</useDefaultName>
    <name>Global Variable Date/Time: global_atoma_refresh_time</name>
    <enabled>true</enabled>
    <variable>global_atoma_refresh_time</variable>
    <executeWhenMissed>false</executeWhenMissed>
    <executed>0</executed>
    <executeAt>1672727693211</executeAt>
    <allowInDeviceIdle>false</allowInDeviceIdle>
    <likeAlarmClock>false</likeAlarmClock>
  </trigger>
  <trigger type="periodic_timer">
    <useDefaultName>true</useDefaultName>
    <name>Periodic Timer: every 1h, 8:01 am - 11:00 pm</name>
    <enabled>true</enabled>
    <frequency>3600000</frequency>
    <wakeDevice>true</wakeDevice>
    <fixedTimes>false</fixedTimes>
    <limitTimeRange>true</limitTimeRange>
    <weekday>Mon</weekday>
    <weekday>Tue</weekday>
    <weekday>Wed</weekday>
    <weekday>Thu</weekday>
    <weekday>Fri</weekday>
    <weekday>Sat</weekday>
    <weekday>Sun</weekday>
    <hourFrom>8</hourFrom>
    <minuteFrom>1</minuteFrom>
    <hourTo>23</hourTo>
    <minuteTo>0</minuteTo>
    <allowInDeviceIdle>true</allowInDeviceIdle>
    <likeAlarmClock>false</likeAlarmClock>
  </trigger>
  <condition type="expression">
    <useDefaultName>true</useDefaultName>
    <name>Expression: length(threshold_offers) &gt; 0</name>
    <expression>length(threshold_offers) &gt; 0</expression>
  </condition>
  <action type="script">
    <useDefaultName>false</useDefaultName>
    <name>Build message</name>
    <script>/*
  Construct human readable summary
*/

threshold_summaries=newList();

for (o in threshold_offers) {
	// Name, base level, level and rarity

	slash_segments=split(o["item_name"], "\/");
	underscore_segments=split(slash_segments[length(slash_segments) - 1], "_");
	item_short_name=underscore_segments[0];
	item_short_name_capitalised=toUpperCase(left(item_short_name, 1)) + substring(item_short_name, 1);

	color="";

	if (o["rarity"] == 1) {
		color = "grey";
	}
	if (o["rarity"] == 2) {
		color = "green";
	}
	if (o["rarity"] == 3) {
		color = "blue";
	}
	if (o["rarity"] == 4) {
		color = "purple";
	}
	if (o["rarity"] == 5) {
		color = "orange";
	}

	base_stats_summaries=newList();

	for (stat in o["base_stats"]) {
		stat_name=replace(stat["name"], "{o['item_name']}_", "");
		stat_name=replace(stat["name"], "{item_short_name}_", "");
		stat_name=replaceAll(stat_name, "\\w\\d_", "");
		stat_name=replace(stat_name, "_stat", "");
		stat_name=replace(stat_name, "_", " ");
		stat_name=toUpperCase(left(stat_name, 1)) + substring(stat_name, 1);
		stat_percentage=round(stat['value'] * 100);

		addElement(base_stats_summaries, "{stat_name} ({stat_percentage, numberformat, ##})");
	}

	base_stat_text=join(base_stats_summaries, ", ");

	// Perks

	perk_summaries=newList();

	for (perk in o["perks"]) {
		slash_segments=split(perk["id"], "\/");
		perk_desc=slash_segments[length(slash_segments) - 1];
		perk_desc=replace(perk_desc, "_", " ");
		perk_desc=toUpperCase(left(perk_desc, 1)) + substring(perk_desc, 1); // capitalise

		addElement(perk_summaries, "- {perk_desc} (P{perk['rarity']})");
	}

	perks_text=join(perk_summaries, " ");

	// Traits

	trait_summaries=newList();

	for (trait in o["traits"]) {
		slash_segments=split(trait["id"], "\/");
		trait_desc=slash_segments[length(slash_segments) - 1];
		trait_desc=replace(trait_desc, "_", " ");
		trait_desc=toUpperCase(left(trait_desc, 1)) + substring(trait_desc, 1); // capitalise
	
		addElement(trait_summaries, "- {trait_desc} (B{trait['rarity']})");
	}

	traits_text=join(trait_summaries, '\n');

	summary = "{item_short_name_capitalised} ({o['base_item_level']}/{o['item_level']} {color})\n- {base_stat_text}";

	if (length(perk_summaries) &gt; 0) {
		summary="{summary}\n{perks_text}";
	}
	if (length(trait_summaries) &gt; 0) {
		summary="{summary}\n{traits_text}";
	}

	addElement(threshold_summaries, summary);
}

global_atoma_title="{length(threshold_offers)} Ã— {base_item_level_threshold}+ items";
global_atoma_summary=join(threshold_summaries, "\n\n");
</script>
  </action>
  <action type="notification_status_bar">
    <useDefaultName>false</useDefaultName>
    <name>Darktide Shop Alert</name>
    <notificationIconType>BUILTIN</notificationIconType>
    <notificationIcon>FACTORY</notificationIcon>
    <customNotificationIcon></customNotificationIcon>
    <title>{global_atoma_title}</title>
    <message></message>
    <channel></channel>
    <sound>false</sound>
    <vibrate>false</vibrate>
    <flashLED>false</flashLED>
    <flashLEDColor>#ff00ff00</flashLEDColor>
    <flashLEDOn>500</flashLEDOn>
    <flashLEDOff>500</flashLEDOff>
    <flagLocalOnly>false</flagLocalOnly>
    <accentColorEnabled>false</accentColorEnabled>
    <accentColor>#ffff0000</accentColor>
    <flagOngoing>false</flagOngoing>
    <flagNoClear>false</flagNoClear>
    <notificationIDEnabled>false</notificationIDEnabled>
    <notificationID>1</notificationID>
    <category>DEFAULT</category>
    <priority>DEFAULT</priority>
    <visibility>PUBLIC</visibility>
    <messageBigEnabled>true</messageBigEnabled>
    <messageBig>{global_atoma_summary}</messageBig>
    <showProgressbar>false</showProgressbar>
    <progressbarIndeterminate>false</progressbarIndeterminate>
    <progressbarValue>0</progressbarValue>
    <progressbarMaximum>100</progressbarMaximum>
    <largeIconEnabled>false</largeIconEnabled>
    <largeIcon></largeIcon>
    <group></group>
    <isGroupSummary>false</isGroupSummary>
    <actionRef text="View summary" icon="AUTOMAGIC" remove="true">Show Atoma summary</actionRef>
  </action>
  <action type="http_request">
    <useDefaultName>false</useDefaultName>
    <name>Fetch queue/refresh endpoint</name>
    <url>https://bsp-auth-prod.atoma.cloud/queue/refresh</url>
    <verifyCertificates>true</verifyCertificates>
    <basicAuthentication>false</basicAuthentication>
    <username></username>
    <clientCert>false</clientCert>
    <clientCertPath></clientCertPath>
    <httpMethod>GET</httpMethod>
    <networkType>DEFAULT</networkType>
    <httpContentType>X_WWW_FORM_URLENCODED</httpContentType>
    <contentType>text/plain</contentType>
    <generalTextData></generalTextData>
    <formFieldList>Lastname=XYZ,Firstname=ABC</formFieldList>
    <uploadFieldName>upload_field</uploadFieldName>
    <uploadFilePath></uploadFilePath>
    <timeout>60000</timeout>
    <setCustomHTTPHeaders>true</setCustomHTTPHeaders>
    <customHTTPHeaders>Authorization: Bearer {atoma_token}</customHTTPHeaders>
    <storeInVariable>true</storeInVariable>
    <variable>atoma_refresh_response</variable>
    <path>/storage/emulated/0/Download/file.bin</path>
    <followRedirects>true</followRedirects>
  </action>
  <action type="http_request">
    <useDefaultName>false</useDefaultName>
    <name>Fetch queue/refresh endpoint with RefreshToken</name>
    <url>https://bsp-auth-prod.atoma.cloud/queue/refresh</url>
    <verifyCertificates>false</verifyCertificates>
    <basicAuthentication>false</basicAuthentication>
    <username></username>
    <clientCert>false</clientCert>
    <clientCertPath></clientCertPath>
    <httpMethod>GET</httpMethod>
    <networkType>DEFAULT</networkType>
    <httpContentType>X_WWW_FORM_URLENCODED</httpContentType>
    <contentType>text/plain</contentType>
    <generalTextData></generalTextData>
    <formFieldList>Lastname=XYZ,Firstname=ABC</formFieldList>
    <uploadFieldName>upload_field</uploadFieldName>
    <uploadFilePath></uploadFilePath>
    <timeout>60000</timeout>
    <setCustomHTTPHeaders>true</setCustomHTTPHeaders>
    <customHTTPHeaders>Authorization: Bearer {global_atoma_refresh["RefreshToken"]}</customHTTPHeaders>
    <storeInVariable>true</storeInVariable>
    <variable>atoma_refresh_response</variable>
    <path>/storage/emulated/0/Download/file.bin</path>
    <followRedirects>true</followRedirects>
  </action>
  <action type="http_request">
    <useDefaultName>false</useDefaultName>
    <name>GET store</name>
    <url>{atoma_store_zealot}</url>
    <verifyCertificates>false</verifyCertificates>
    <basicAuthentication>false</basicAuthentication>
    <username></username>
    <clientCert>false</clientCert>
    <clientCertPath></clientCertPath>
    <httpMethod>GET</httpMethod>
    <networkType>DEFAULT</networkType>
    <httpContentType>X_WWW_FORM_URLENCODED</httpContentType>
    <contentType>text/plain</contentType>
    <generalTextData></generalTextData>
    <formFieldList>Lastname=XYZ,Firstname=ABC</formFieldList>
    <uploadFieldName>upload_field</uploadFieldName>
    <uploadFilePath></uploadFilePath>
    <timeout>60000</timeout>
    <setCustomHTTPHeaders>true</setCustomHTTPHeaders>
    <customHTTPHeaders>Authorization: Bearer {global_atoma_refresh["AccessToken"]}</customHTTPHeaders>
    <storeInVariable>true</storeInVariable>
    <variable>atoma_store_response</variable>
    <path>/storage/emulated/0/Download/file.bin</path>
    <followRedirects>true</followRedirects>
  </action>
  <action type="http_request">
    <useDefaultName>true</useDefaultName>
    <name>HTTP Request: GET https://bsp-td-prod.atoma.cloud/web/{global_atoma_refresh["Sub"]}/summary   store in atoma_summary_response</name>
    <url>https://bsp-td-prod.atoma.cloud/web/{global_atoma_refresh["Sub"]}/summary</url>
    <verifyCertificates>false</verifyCertificates>
    <basicAuthentication>false</basicAuthentication>
    <username></username>
    <clientCert>false</clientCert>
    <clientCertPath></clientCertPath>
    <httpMethod>GET</httpMethod>
    <networkType>DEFAULT</networkType>
    <httpContentType>X_WWW_FORM_URLENCODED</httpContentType>
    <contentType>text/plain</contentType>
    <generalTextData></generalTextData>
    <formFieldList>Lastname=XYZ,Firstname=ABC</formFieldList>
    <uploadFieldName>upload_field</uploadFieldName>
    <uploadFilePath></uploadFilePath>
    <timeout>60000</timeout>
    <setCustomHTTPHeaders>true</setCustomHTTPHeaders>
    <customHTTPHeaders>Authorization: Bearer {global_atoma_refresh["AccessToken"]}</customHTTPHeaders>
    <storeInVariable>true</storeInVariable>
    <variable>atoma_summary_response</variable>
    <path>/storage/emulated/0/Download/file.bin</path>
    <followRedirects>true</followRedirects>
  </action>
  <action type="script">
    <useDefaultName>false</useDefaultName>
    <name>Parse `queue/refresh` response</name>
    <script>global_atoma_refresh=fromJSON(atoma_refresh_response);
global_atoma_refresh_time=getDate();
global_atoma_refresh_time=addSeconds(global_atoma_refresh_time, global_atoma_refresh["ExpiresIn"] - 10);</script>
  </action>
  <action type="script">
    <useDefaultName>false</useDefaultName>
    <name>Parse Store Items</name>
    <script>base_item_level_threshold=360;
threshold_offers=newList();

for (offer in atoma_store["personal"]) {
	slash_segments=split(offer["description"]["id"], "\/");
	item_name=slash_segments[length(slash_segments) - 1];
	stats=offer["description"]["overrides"];

	if (stats["baseItemLevel"] &gt;= base_item_level_threshold) {
		item=newMap();
		addMapEntry(item, "item_name", item_name);
		addMapEntry(item, "base_item_level", stats["baseItemLevel"]);
		addMapEntry(item, "item_level", stats["itemLevel"]);
		addMapEntry(item, "rarity", stats["rarity"]);
		addMapEntry(item, "base_stats", stats["base_stats"]);
		addMapEntry(item, "perks", stats["perks"]);
		addMapEntry(item, "traits", stats["traits"]);
		addMapEntry(item, "", stats[""]);
		addMapEntry(item, "", stats[""]);

		addElement(threshold_offers, item);
	}
}</script>
  </action>
  <action type="script">
    <useDefaultName>true</useDefaultName>
    <name>Script: atoma_store=fromJSON(atoma_store_response);</name>
    <script>atoma_store=fromJSON(atoma_store_response);</script>
  </action>
  <action type="script">
    <useDefaultName>true</useDefaultName>
    <name>Script: atoma_summary=fromJSON(atoma_summary_response); atoma_characters=atoma_summary["characters"]; for (character in atoma_characters) { if (character["name"] == atoma_character) { atoma_character_id=character["id"]; } }; atoma_store_ogryn="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_ogryn?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}"; atoma_store_psyker="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_psyker?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}"; atoma_store_veteran="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_veteran?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}"; atoma_store_zealot="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_zealot?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}";</name>
    <script>atoma_summary=fromJSON(atoma_summary_response);
atoma_characters=atoma_summary["characters"];

for (character in atoma_characters) {
  if (character["name"] == atoma_character) {
    atoma_character_id=character["id"];
  }
};

atoma_store_ogryn="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_ogryn?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}";
atoma_store_psyker="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_psyker?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}";
atoma_store_veteran="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_veteran?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}";
atoma_store_zealot="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_zealot?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}";</script>
  </action>
  <action type="script">
    <useDefaultName>false</useDefaultName>
    <name>Select Character</name>
    <script>atoma_character="YOUR_OPERATIVE_NAME";</script>
  </action>
  <action type="script">
    <useDefaultName>false</useDefaultName>
    <name>Set refresh token</name>
    <script>atoma_token="";

if (global_atoma_refresh["RefreshToken"]) {
  atoma_token=global_atoma_refresh["RefreshToken"];
} else {
atoma_token="YOUR_REFRESH_TOKEN_COPIED_FROM_ATOMA.CLOUD/QUEUE/REFRESH_NETWORK_REQUEST";
}</script>
  </action>
  <action type="message_dialog">
    <useDefaultName>false</useDefaultName>
    <name>Show Atoma summary</name>
    <title>{global_atoma_title}</title>
    <message>{global_atoma_summary}</message>
    <buttonLabel></buttonLabel>
    <timeoutEnabled>false</timeoutEnabled>
    <timeout>60000</timeout>
  </action>
  <action type="sleep">
    <useDefaultName>true</useDefaultName>
    <name>Sleep: {global_atoma_refresh["ExpiresIn"] -10}s (keep device awake)</name>
    <duration>{global_atoma_refresh["ExpiresIn"] -10}s</duration>
    <keepDeviceAwake>true</keepDeviceAwake>
    <allowWakeupFromDeviceIdle>false</allowWakeupFromDeviceIdle>
  </action>
  <flow type="flow">
    <name>Atoma Check</name>
    <enabled>true</enabled>
    <executionPolicy>PARALLEL</executionPolicy>
    <actioncontainer id="t1" x="350.0" y="542.50006">GET store</actioncontainer>
    <actioncontainer id="t2" x="350.00003" y="367.5003">Script: atoma_summary=fromJSON(atoma_summary_response); atoma_characters=atoma_summary["characters"]; for (character in atoma_characters) { if (character["name"] == atoma_character) { atoma_character_id=character["id"]; } }; atoma_store_ogryn="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_ogryn?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}"; atoma_store_psyker="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_psyker?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}"; atoma_store_veteran="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_veteran?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}"; atoma_store_zealot="https://bsp-td-prod.atoma.cloud/store/storefront/credits_store_zealot?accountId={global_atoma_refresh['Sub']}&amp;personal=true&amp;characterId={atoma_character_id}";</actioncontainer>
    <actioncontainer id="t3" x="350.0" y="717.5">Script: atoma_store=fromJSON(atoma_store_response);</actioncontainer>
    <actioncontainer id="t4" x="350.0" y="192.50002">HTTP Request: GET https://bsp-td-prod.atoma.cloud/web/{global_atoma_refresh["Sub"]}/summary   store in atoma_summary_response</actioncontainer>
    <actioncontainer id="t5" x="350.0" y="1067.5">Build message</actioncontainer>
    <actioncontainer id="t6" x="350.0" y="1417.5">Darktide Shop Alert</actioncontainer>
    <conditioncontainer id="t7" x="350.0" y="1242.5">Expression: length(threshold_offers) &gt; 0</conditioncontainer>
    <actioncontainer id="t8" x="350.00006" y="892.4999">Parse Store Items</actioncontainer>
    <actioncontainer id="t9" x="70.0" y="192.5">Select Character</actioncontainer>
    <triggercontainer id="t10" x="70.00001" y="52.500004">
      <trigger>Periodic Timer: every 1h, 8:01 am - 11:00 pm</trigger>
    </triggercontainer>
    <connection from="t1" to="t3" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t2" to="t1" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t3" to="t8" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t4" to="t2" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t5" to="t7" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t7" to="t6" type="TRUE" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t8" to="t5" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t9" to="t4" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t10" to="t9" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
  </flow>
  <flow type="flow">
    <name>Atoma Refresh</name>
    <enabled>true</enabled>
    <executionPolicy>PARALLEL</executionPolicy>
    <actioncontainer id="t1" x="70.00006" y="927.50024">Fetch queue/refresh endpoint with RefreshToken</actioncontainer>
    <actioncontainer id="t2" x="69.999954" y="752.49963">Sleep: {global_atoma_refresh["ExpiresIn"] -10}s (keep device awake)</actioncontainer>
    <triggercontainer id="t3" x="70.0" y="52.5">
      <trigger>Global Variable Date/Time: global_atoma_refresh_time</trigger>
    </triggercontainer>
    <actioncontainer id="t4" x="70.000015" y="402.50006">Fetch queue/refresh endpoint</actioncontainer>
    <actioncontainer id="t5" x="69.99993" y="227.50006">Set refresh token</actioncontainer>
    <actioncontainer id="t6" x="69.99995" y="577.49976">Parse `queue/refresh` response</actioncontainer>
    <connection from="t2" to="t1" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t3" to="t5" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t4" to="t6" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
    <connection from="t5" to="t4" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
  </flow>
  <flow type="flow">
    <name>Atoma Show</name>
    <enabled>true</enabled>
    <executionPolicy>PARALLEL</executionPolicy>
    <triggercontainer id="t1" x="70.0" y="52.5" />
    <actioncontainer id="t2" x="70.000015" y="227.49998">Show Atoma summary</actioncontainer>
    <connection from="t1" to="t2" type="NORMAL" sourcePosition="SOUTH" targetPosition="NORTH" />
  </flow>
</data>
